<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>HandyMans One-Tap Reply</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f7f5f1;color:#2a2a2a;margin:0;padding:20px}
    .card{max-width:680px;margin:0 auto;background:#fff;border:1px solid #e6dfd2;border-radius:14px;padding:20px}
    h1{font-size:22px;margin:0 0 8px;color:#3a3125}
    p{margin:6px 0 0;line-height:1.5}
    .meta{background:#f7f5f1;border-radius:10px;padding:12px;margin:14px 0;font-size:14px}
    textarea{width:100%;min-height:110px;border:1px solid #d9d1c0;border-radius:10px;padding:12px;font-size:14px;box-sizing:border-box}
    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    a.btn,button.btn{display:inline-block;text-align:center;text-decoration:none;border:none;cursor:pointer;padding:12px 14px;border-radius:10px;font-weight:700;font-size:14px}
    .b1{background:#2f4f4f;color:#fff}
    .b2{background:#4e342e;color:#fff}
    .b3{background:#1f6f43;color:#fff}
    .b4{background:#7a5c1f;color:#fff}
    .hint{font-size:12px;color:#6b6457;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>HandyMans One-Tap Reply</h1>
    <p>Open SMS/Call/WhatsApp for this lead without searching contacts.</p>

    <div class="meta" id="meta">Loading lead context...</div>

    <label for="msg"><strong>Message</strong></label>
    <textarea id="msg"></textarea>

    <div class="grid">
      <button class="btn b1" id="smsIos">Open SMS iPhone</button>
      <button class="btn b2" id="smsAndroid">Open SMS Android</button>
      <a class="btn b3" id="whatsapp" href="#">Open WhatsApp</a>
      <a class="btn b4" id="call" href="#">Open Call</a>
      <button class="btn" id="copyBtn">Copy Text</button>
    </div>

    <p class="hint">If SMS app doesn't open, copy the text and call/WhatsApp manually.</p>
  </div>

  <script>
    const q = new URLSearchParams(window.location.search);
    const leadId = q.get('leadId') || '';
    const phone = q.get('phone') || '';
    const lang = q.get('lang') || 'en';
    const action = q.get('action') || 'greeting';
    const initialText = q.get('text') || '';

    const msgEl = document.getElementById('msg');
    const metaEl = document.getElementById('meta');
    const smsIosBtn = document.getElementById('smsIos');
    const smsAndroidBtn = document.getElementById('smsAndroid');
    const waEl = document.getElementById('whatsapp');
    const callEl = document.getElementById('call');
    const copyBtn = document.getElementById('copyBtn');

    msgEl.value = initialText;

    const cleanPhone = String(phone).replace(/[^\d+]/g, '');
    const waPhone = cleanPhone.replace(/\D/g, '');

    metaEl.innerHTML = `<strong>Lead:</strong> ${escapeHtml(leadId)}<br><strong>Phone:</strong> ${escapeHtml(cleanPhone)}<br><strong>Lang:</strong> ${escapeHtml(lang)} Â· <strong>Action:</strong> ${escapeHtml(action)}`;

    function buildLinks() {
      const text = encodeURIComponent(msgEl.value || '');
      return {
        ios: `sms:${cleanPhone}&body=${text}`,
        android: `sms:${cleanPhone}?body=${text}`,
        wa: `https://wa.me/${waPhone}?text=${text}`,
        call: `tel:${cleanPhone}`
      };
    }

    function openLink(url) {
      window.location.href = url;
    }

    smsIosBtn.addEventListener('click', () => {
      const links = buildLinks();
      openLink(links.ios);
    });

    smsAndroidBtn.addEventListener('click', () => {
      const links = buildLinks();
      openLink(links.android);
    });

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(msgEl.value || '');
        copyBtn.textContent = 'Copied';
        setTimeout(() => { copyBtn.textContent = 'Copy Text'; }, 1200);
      } catch (err) {
        alert('Copy failed, select text manually.');
      }
    });

    msgEl.addEventListener('input', () => {
      const links = buildLinks();
      waEl.href = links.wa;
      callEl.href = links.call;
    });

    const initialLinks = buildLinks();
    waEl.href = initialLinks.wa;
    callEl.href = initialLinks.call;

    function escapeHtml(s) {
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }
  </script>
</body>
</html>
